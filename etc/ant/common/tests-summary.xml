<?xml version="1.0" encoding="UTF-8" ?>
<project>
  <!--
        Counts lines containing a given pattern in a given resource set.
    -->
  <macrodef name="count-lines">
    <attribute name="pattern"  />
    <attribute name="property"  />
    <attribute name="fileset-refid"  />

    <sequential>
      <resourcecount property="@{property}">
        <tokens>
          <concat>
            <filterchain>
              <tokenfilter>
                <linetokenizer/>
                <containsregex pattern="@{pattern}" />
              </tokenfilter>
            </filterchain>
            <fileset refid="@{fileset-refid}" />
          </concat>
        </tokens>
      </resourcecount>
    </sequential>
  </macrodef>
  
  <macrodef name="tests-summary">
    <attribute name="fileset-refid"  />

    <sequential>
      <local name="count.tests"/>
      <local name="count.ignored"/>
      <local name="count.assumptions"/>
      <local name="count.failed"/>
      <local name="count.errors"/>
  
      <count-lines pattern="^OK"             property="count.tests"       fileset-refid="@{fileset-refid}" />
      <count-lines pattern="^(A/)?IGNORED"   property="count.ignored"     fileset-refid="@{fileset-refid}" />
      <count-lines pattern="^A/IGNORED"      property="count.assumptions" fileset-refid="@{fileset-refid}" />
      <count-lines pattern="^FAILED"         property="count.failed"      fileset-refid="@{fileset-refid}" />
      <count-lines pattern="^ERROR"          property="count.errors"      fileset-refid="@{fileset-refid}" />
  
      <echo level="info">

Tests summary: ${count.tests} successful tests, ${count.failed} failures, ${count.errors} errors, ${count.ignored} ignored (${count.assumptions} assumptions).

      </echo>
    </sequential>
  </macrodef>
</project>
