<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V5.0//EN"
                 "http://www.docbook.org/xml/5.0/dtd/docbook.dtd" [
  <!ENTITY % local SYSTEM "local-entities.ent">
  <!ENTITY % custom SYSTEM "custom-entities.ent">
  %local;
  %custom;
]>
<chapter xml:id="chapter.customizing" version="5.0"
         xmlns="http://docbook.org/ns/docbook"
         xmlns:product="http://www.carrot2.org">
  <title>Customizing &PROD;</title>
  <subtitle>Customizing &PROD; components and applications</subtitle>

  <para>
    This chapter will show you how to add new document sources to &PROD; 
    applications and tune &PROD; clustering for your specific data.
  </para>

  <section xml:id="section.customizing.component-suites-and-attributes">
    <title>Component suites and attributes</title>
    
    <para>
      Key concepts in customizing and tuning &PROD; applications are 
      component suites and component attributes described in the following sections. 
    </para>
    
    <section xml:id="section.customizing.component-suites-and-attributes.component-suites">
      <title>Component suites</title>
    
      <para>
        <emphasis>Component suite</emphasis> 
        is a set of &C2; components, such as document sources or clustering algorithms, 
        configured to work within a specific &PROD; application. For each component, the
        component suite defines the component's identifier, label, description and also
        a number of component- and application-specific properties, such as the list of example 
        queries. 
      </para>
      
      <para>
        Component suites are defined in XML files read from application-specific locations
        described in further sections of this chapter. An example component
        suite definition is shown in <xref linkend="figure.component-suite-example" />.
      </para>
      
      <figure xml:id="figure.component-suite-example">
        <title>Example &C2; component suite</title>
        <programlisting><![CDATA[<component-suite>
  <sources>
    <source id="lucene"
        component-class="org.carrot2.source.lucene.LuceneDocumentSource"
        attribute-sets-resource="lucene.attributes.xml">
      <label>Lucene</label>
      <title>Apache Lucene</title>
      <mnemonic>L</mnemonic>
      <description>
        Apache Lucene index (local index access).
      </description>
      <icon-path>icons/lucene.png</icon-path>
      <example-queries>
        <example-query>data mining</example-query>
        <example-query>london</example-query>
        <example-query>clustering</example-query>
      </example-queries>
    </source>
  </sources>
  
  <algorithms>
    <algorithm id="lingo" 
        component-class="org.carrot2.clustering.lingo.LingoClusteringAlgorithm" 
        attribute-sets-resource="lingo.attributes.xml">
      <label>Lingo</label>
      <title>Lingo Clustering</title>
    </algorithm>
  </algorithms>
  
  <include suite="source-yahoo-boss.xml" />
  <include suite="algorithm-stc.xml" />
</component-suite>]]></programlisting>      
      </figure>
      
      <para>
        The component suite definition can consist of the following elements:
      </para>
      
      <itemizedlist>
        <listitem>
          <formalpara>
            <title><tag>sources</tag></title>
            <para>
              Document source definitions, optional.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>algorithms</tag></title>
            <para>
              Clustering algorithm definitions, optional.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>include</tag></title>
            <para>
              Includes other XML component suite definitions, optional. The resource 
              specified in the <tag>suite</tag> attribute will be loaded from the current 
              thread's context class loader.
            </para>
          </formalpara>
        </listitem>
      </itemizedlist>
      
      <para>
        Common parts of the <tag>source</tag> and <tag>algorithm</tag> tags include:
      </para>
      
      <itemizedlist>
        <listitem>
          <formalpara>
            <title><tag>id</tag></title>
            <para>
              Identifier of the component within the suite, required. Identifiers
              must be unique within the component suite scope.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>component-class</tag></title>
            <para>
              Fully qualified name of the processing component class, required.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>attribute-sets-resource</tag></title>
            <para>
              XML file to load the component's attributes from. The resource specified in 
              this attribute will be loaded from the current thread's context 
              class loader. For the syntax of the XML file, please see
              <xref linkend="section.customizing.component-suites-and-attributes.component-attributes" />.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>label</tag></title>
            <para>
              A human readable label of the component, required.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>label</tag></title>
            <para>
              A human readable title of the component, required. The title will be usually
              slightly longer than the label.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>description</tag></title>
            <para>
              A longer description of the component, optional.
            </para>
          </formalpara>
        </listitem>
        
        <listitem>
          <formalpara>
            <title><tag>icon-path</tag></title>
            <para>
              Application specific definition of the component's icon.
            </para>
          </formalpara>
        </listitem>
      </itemizedlist>

      <para>
        Additionally, for the <tag>source</tag> tag you can use the <tag>example-queries</tag> tag 
        to specify some example queries the applications may show for this source.
      </para>
    </section>  
      
    <section xml:id="section.customizing.component-suites-and-attributes.component-attributes">
      <title>Component attributes</title>
      
      <para>  
        <emphasis>Component attribute</emphasis> is a specific property of a
        &C2; component that influences its behavior, e.g. the number of search results fetched
        by a document source or the depth of cluster hierarchy produced by a clustering algorithm.
        Each attribute is identified by a unique string key, <xref linkend="chapter.components" /> 
        lists and describes all available components and their attributes.
      </para>
      
      <para>
        You can specify attribute values for specific components in the component suite
        using <emphasis>attribute sets</emphasis>. Attribute sets are defined in XML files
        referenced by the <tag>attribute-sets-resource</tag> attribute of the component's
        entry in the component suite. <xref linkend="figure.attribute-set-example" />
        shows an example attribute set definition. 
      </para>
      
      <figure xml:id="figure.attribute-set-example">
        <title>Example &C2; attribute set</title>
        <programlisting><![CDATA[<attribute-sets>
  <attribute-set id="lucene">
    <value-set>
      <label>Lucene</label>
      <attribute key="LuceneDocumentSource.directory">
        <value>
           <wrapper class="org.carrot2.source.lucene.FSDirectoryWrapper">
              <indexPath>/path/to/lucene/index/directory</indexPath>
           </wrapper>
        </value>
      </attribute>
      <attribute key="org.carrot2.source.lucene.SimpleFieldMapper.contentField">
        <value type="java.lang.String" value="summary" />
      </attribute>
      <attribute key="org.carrot2.source.lucene.SimpleFieldMapper.titleField">
        <value type="java.lang.String" value="title" />
      </attribute>
      <attribute key="org.carrot2.source.lucene.SimpleFieldMapper.urlField">
        <value type="java.lang.String" value="url" />
      </attribute>
    </value-set>
  </attribute-set>
</attribute-sets>]]></programlisting>      
      </figure>
      
      <para>
        An <tag>attribute-sets</tag> element can contain one or more 
        <tag>attribute-set</tag>s. Each <tag>attribute-set</tag> must specify a unique
        <tag>id</tag> and a <tag>value-set</tag>.
        As the syntax of the <tag>value</tag> elements depends on the type of the 
        attribute being set, the easiest way to obtain the XML file is to use
        the &DCW;.
      </para>
      
      <para>
        To generate attribute set XML for a document source:
      </para>
      
      <orderedlist>
        <listitem>
          <para>
            In the <guilabel>Search</guilabel> view, choose the document source for which 
            you would like to save attributes.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Use the <guilabel>Search</guilabel> view to set the desired attribute values.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Choose the <guilabel>Save as...</guilabel> option from <guilabel>Search</guilabel>
            view's menu bar. &DCW; will suggest the XML file name based on the value of
            the document source's <tag>attribute-sets-resource</tag> attribute.
          </para>
        </listitem>
      </orderedlist>
      
      <note>
        <para>
          Please note that the &DCW; will remove a number of common attributes from the
          XML file being saved, including: query, start result index, number of results.
        </para>
      </note>      
      
      <para>
        To generate attribute set XML for a clustering algorithm:
      </para>
      
      <orderedlist>
        <listitem>
          <para>
            In the <guilabel>Search</guilabel> view, choose the clustering algorithm for 
            which you would like to save attributes. Choose any document source and
            perform processing using the selected algorithm.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Use the <guilabel>Attributes</guilabel> view to set the desired attribute
            values.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Choose the <guilabel>Save as...</guilabel> option from <guilabel>Attribute</guilabel>
            view's menu bar. &DCW; will suggest the XML file name based on the value of
            the clustering algorithm's <tag>attribute-sets-resource</tag> attribute.
          </para>
        </listitem>
      </orderedlist>
      
      <tip role="c2">
        <para>
          If for some reason you cannot use the &DCW; to save attribute set XML files,
          you can modify the <classname>SavingAttributeValuesToXml</classname> class from the
          <classname>carrot2-examples</classname> package to correspond to the attribute values
          you would like to set and run the class to print the XML encoding of the 
          attribute values to the standard output. 
        </para>
      </tip>
    </section>
  </section>

  <section xml:id="section.customizing.adding-source-to-webapp">
    <title>Adding document sources to &WA;</title>
    
    <para>
      To add a document source tab to the &WA;:
    </para>
    
    <orderedlist>
      <listitem>
        <para>
          Download <product:webapp-download-link>&WA; WAR file</product:webapp-download-link>.
        </para>
      </listitem>
    
      <listitem>
        <para>
          Open for editing the <filename>suite-webapp.xml</filename> file, located in the 
          <filename>WEB-INF/classes/suites</filename> directory of the 
          WAR file.
        </para>
      </listitem>

      <listitem>
        <para>
          Add a descriptor for the document source you want to add to the <tag>sources</tag> 
          section of the <filename>suite-webapp.xml</filename> file. Alternatively, you 
          may want to use the <tag>include</tag> element to reference one of the example 
          document source descriptors shipped with the  application (e.g. 
          <filename>source-lucene.xml</filename>). Please see 
          <xref linkend="section.customizing.component-suites-and-attributes.component-suites" />
          for more information about the component suite XML file.
        </para>
      </listitem>
      
      <listitem>
        <para>
          If the document source you are adding requires setting specific attribute values
          (e.g. index location for the Lucene document source), 
          <link linkend="section.customizing.component-suites-and-attributes.component-attributes">use 
          the &DCW; to generate the attribute set XML file</link>. Place the generated
          XML file in <filename>WEB-INF/classes/suites</filename> and make
          sure it is appropriately referenced by the <tag>attribute-sets-resource</tag>
          attribute of the descriptor added in the previous step. 
        </para>
      </listitem>

      <listitem>
        <para>
          Deploy the WAR file with the above modifications to your container.
          If the new document source tab is not showing, clear cookies for the domain on which
          the web application is deployed.
        </para>
      </listitem>        
    </orderedlist>
  </section>
  
  <section xml:id="section.customizing.adding-source-to-dcs">
    <title>Adding document sources to &DCS;</title>
    
    <para>
      To add a document source tab to the &DCS;:
    </para>
    
    <orderedlist>
      <listitem>
        <para>
          Download <product:dcs-download-link>&DCS; distribution archive</product:dcs-download-link> 
          and extract it to some local folder.
        </para>
      </listitem>
    
      <listitem>
        <para>
          Open for editing the <filename>suite-dcs.xml</filename> file, located in the 
          <filename>WEB-INF/classes/suites</filename> directory of the 
          DCS WAR file located in the <filename>war/</filename> of the DCS distribution.
        </para>
      </listitem>

      <listitem>
        <para>
          Add a descriptor for the document source you want to add to the <tag>sources</tag> 
          section of the <filename>suite-dcs.xml</filename> file. Alternatively, you may want to use the <tag>include</tag> element to
          reference one of the example document source descriptors shipped with the 
          application (e.g. <filename>source-lucene.xml</filename>). Please see 
          <xref linkend="section.customizing.component-suites-and-attributes.component-suites" />
          for more information about the component suite XML file.
        </para>
      </listitem>
      
      <listitem>
        <para>
          If the document source you are adding requires setting specific attribute values
          (e.g. index location for the Lucene document source), 
          <link linkend="section.customizing.component-suites-and-attributes.component-attributes">use 
          the &DCW; to generate the attribute set XML file</link>. Place the generated
          XML file in <filename>WEB-INF/classes/suites</filename> 
          and make sure it is appropriately referenced by the <tag>attribute-sets-resource</tag>
          attribute of the descriptor added in the previous step. 
        </para>
      </listitem>

      <listitem>
        <para>
          Restart the DCS. The new document source should be available for processing.
        </para>
      </listitem>        
    </orderedlist>
  </section>
  
  <section xml:id="section.customizing.customizing-lingo-for-webapp">
    <title>Customizing Lingo for &WA;</title>
      
    <para>
      To run the &WA; with custom <link linkend="section.component.lingo">attributes of the Lingo clustering algorithm</link>:
    </para>
    
    <orderedlist>
      <listitem>
        <para>
          <link linkend="section.customizing.component-suites-and-attributes.component-attributes">Use the &DCW; to save the attribute set XML file</link> 
          with the desired Lingo attribute values.
        </para>
      </listitem>
      
      <listitem>
        <para>
          Replace the contents of <filename>lingo.attributes.xml</filename>, located in
          the <filename>WEB-INF/classes/suites</filename> directory of the web application
          WAR file, with the XML file saved in the previous step.
        </para>
      </listitem>
      
      <listitem>
        <para>
          Deploy the WAR file with the above modifications to your container.
        </para>
      </listitem>        
    </orderedlist>
    
    <para>
      You can use the same procedure to customize other algorithms, e.g. 
      <link linkend="section.component.stc">STC</link>.
    </para>
  </section>
  
  <section xml:id="section.customizing.customizing-lingo-for-dcs">
    <title>Customizing Lingo for &DCS;</title>
      
    <para>
      To run the &DCS; with custom <link linkend="section.component.lingo">attributes of the Lingo clustering algorithm</link>:
    </para>
    
    <orderedlist>
      <listitem>
        <para>
          <link linkend="section.customizing.component-suites-and-attributes.component-attributes">Use the &DCW; to save the attribute set XML file</link> 
          with the desired Lingo attribute values.
        </para>
      </listitem>
      
      <listitem>
        <para>
          Replace the contents of <filename>lingo.attributes.xml</filename>, located in
          the <filename>WEB-INF/classes/suites</filename> directory of the DCS
          WAR file, located in the <filename>war/</filename> of the DCS distribution, 
          with the XML file saved in the previous step.
        </para>
      </listitem>
      
      <listitem>
        <para>
          Restart the DCS.
        </para>
      </listitem>        
    </orderedlist>
    
    <para>
      You can use the same procedure to customize other algorithms, e.g. 
      <link linkend="section.component.stc">STC</link>.
    </para>
  </section>

  <section>
    <title>Adding document sources to &DCW;</title>
    
    <para>
      &NA;
    </para>
  </section>
    
  <section xml:id="section.advanced-topics.fine-tuning">
    <title>Fine-tuning &C2; clustering</title>
    
    <para>
      This section discusses a number of typical fine-tuning scenarios for &C2; clustering
      algorithms. Some of the scenarios are relevant to all &C2; algorithms, while others
      are specific to individual algorithms.
    </para>
    
    <section xml:id="section.advanced-topics.fine-tuning.stop-words">
      <title>Modifying the list of stop words</title>
      
      <para>
        Stop words are the common meaningless words, such as <emphasis>the</emphasis>, 
        <emphasis>to</emphasis>, <emphasis>for</emphasis> in English, that should be 
        ignored while clustering. The Lingo algorithm, for example, will not create
        clusters whose labels start or end in a stop word.
      </para>
      
      <para>
        To fine-tune the stop words list you can use the 
        <link linkend="section.workbench">&DCW;</link> in the following way:
      </para>
      
      <orderedlist>
        <listitem>
          <para>
            Start &DCW; and run some query on which you'll be observing the results
            of your changes.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Go to the <filename>workspace/</filename> directory which is located in
            the directory to which you extracted &DCW;. Modify the <filename>stopwords.*</filename>
            file for the language you are working on (e.g. <filename>stopwords.en</filename>
            for English). Add or remove stop words as required and save changes.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Open the <guilabel>Attributes</guilabel> view in &DCW; and use the view's toolbar
            button shown in <xref linkend="figure.preprocessing-attributes" /> 
            to group the attributes by semantics. In the <guilabel>Preprocessing</guilabel>
            make sure the <guilabel>Processing language</guilabel> is correctly set and
            check the <guilabel>Reload stopwords</guilabel> checkbox. Doing the latter
            will let you to see the updated clustering results without restarting &DCW;
            every time you save the changed stop word list.
          </para>
        </listitem>
        
        <listitem>
          <para>
            Uncheck the <guilabel>Restart Processing Automatically</guilabel>
            option in the <guilabel>Search</guilabel> menu. To rerun clustering after
            you've saved changes to the <filename>stopwords.*</filename>, choose the
            <guilabel>Restart Clustering</guilabel> option from the <guilabel>Search</guilabel>
            menu, or press <guilabel>Ctrl+F11</guilabel>.
          </para>
        </listitem>
      </orderedlist>
      
      <figure xml:id="figure.preprocessing-attributes">
        <title>&DCW; Preprocessing Attributes</title>
        <mediaobject>
          <imageobject role="html">
            <imagedata format="PNG" fileref="img/workbench-preprocessing-attributes.png" />
          </imageobject>
        </mediaobject>  
      </figure>
      
      <tip>
        <para>
          To transfer the changed stop words file to other &C2; applications, update
          the existing stop words file in the <filename>carrot2-core.jar</filename> the application
          is using. In case of the &DCS; and &WA;, the <filename>carrot2-core.jar</filename> is located
          in the <filename>WEB-INF/lib</filename> directory.
        </para>
      </tip>
    </section>
    
    <section xml:id="section.advanced-topics.fine-tuning.stop-regexps">
      <title>Excluding specific clusters from results</title>
      
      <para>
        The Lingo clustering algorithm, in addition to 
        <link linkend="section.advanced-topics.fine-tuning.stop-words">stop words editing</link>,
        offers more precise control over cluster labels by means of "stop label" regular expressions. 
        If a cluster's label matches one of the stop labels, the label will not appear 
        on the list of clusters produced by Lingo.
      </para>
      
      <para>
        The procedure for tuning stop labels and transferring them to other &C2; applications is similar to 
        <link linkend="section.advanced-topics.fine-tuning.stop-words">stop word tuning</link>.
        The difference is that this time you need to edit the <filename>stoplabels.*</filename> files.
        Each line of a stop labels file corresponds to one stop label and is a <link xlink:href="http://java.sun.com/j2se/1.4.2/docs/api/java/util/regex/Pattern.html">Java regular
        expression</link>. Please note that in order to be removed a label <emphasis>as a whole</emphasis> must match 
        at least one of the stop label expressions. A number of example
        stop label expressions are shown below.
      </para>
      
      <programlisting>(?i)new
(?i)information
(?i)information (about|on).*
(?i)(index|list) of.*</programlisting>

      <para>
        All stop labels shown above start with the <tag>(?i)</tag> prefix, which enables 
        case-insensitive matching for them. The stop label in the first line suppresses 
        labels consisting solely of the word <emphasis>new</emphasis>. Similarly, the stop label
        in the second line removes labels consisting of the word <emphasis>information</emphasis>.
        The stop label in the third line removes labels that start in <emphasis>information about</emphasis>
        or <emphasis>information on</emphasis>, and the stop label in the fourth line removes
        labels that start with <emphasis>index of</emphasis> or <emphasis>list of</emphasis>. 
      </para>
      
      <note>
        <para>
          Please note that defining a very large number of stop labels (100+) may 
          significantly slow down clustering. In such cases you may want to combine
          separate stop label expressions into one larger regular expression.
        </para>
      </note>
    </section>
    
    <section xml:id="section.advanced-topics.fine-tuning.reducing-other-topics">
      <title>Reducing the size of the <emphasis>Other Topics</emphasis> cluster</title>
      
      <para>
        The <emphasis>Other Topics</emphasis> cluster contains documents that do not belong
        to any other cluster generated by the algorithm. Depending on the input documents, the size of
        this cluster may vary from a few to tens of documents.
      </para>
      
      <para>
        By tuning parameters of the clustering algorithm, you can reduce the number of
        unclustered documents, however bringing the number down to 0 is unachievable in most cases.
        Please note that minimizing the <emphasis>Other Topics</emphasis> cluster size is usually achieved
        by forcing the algorithm to create more clusters, which may degrade the perceived
        clustering quality.
      </para>
      
      <tip>
        <para>
          The easiest way to try different clustering algorithm settings is to use
          the <link linkend="section.workbench">&DCW;</link>.
        </para>
      </tip>
      
      <section>
        <title>Tuning Lingo algorithm for smallest <emphasis>Other Topics</emphasis> cluster</title>

        <para>
          To reduce the size of the <emphasis>Other Topics</emphasis> cluster generated
          by Lingo, you can try applying the following settings:
        </para>
        
        <orderedlist>
          <listitem>
            <para>
              Change the <link linkend="LingoClusteringAlgorithm.factorizationFactory" role="attribute" /> attribute
              to <classname>LocalNonnegativeMatrixFactorizationFactory</classname>.
            </para>
          </listitem>
          
          <listitem>
            <para>
              Increase the <link linkend="LingoClusteringAlgorithm.desiredClusterCountBase" role="attribute" />
              above the default value.
            </para>
          </listitem>
          
          <listitem>
            <para>
              Decrease the <link linkend="LingoClusteringAlgorithm.phraseLabelBoost" role="attribute" />.
              Note that this will increase the number of one-word labels, which may not always
              be desirable.
            </para>
          </listitem>
        </orderedlist>
      </section>
    </section>
  </section>
</chapter>
