<project name="proto-3.0" default="build">
    <property file="workbench.properties" />

    <property name="workbench.build.dir" value="tmp/workbench" />
    <property name="workbench.tests.report.dir" value="tmp/workbench/test-report" />

    <target name="build" description="Builds workbench without test plugins">
        <java jar="${eclipse.home}/plugins/${equinox.launcher.plugin.jar}"
            fork="true"
            failonerror="true">
            <arg line="-application org.eclipse.ant.core.antRunner" />
            <arg line="-buildfile ${eclipse.home}/plugins/${pde.build.plugin}/scripts/productBuild/productBuild.xml" />
            <arg line="-Dbuilder=${basedir}/workbench/build-conf/" />
            <arg line="-DbuildDirectory=${basedir}/${workbench.build.dir}/build-dir" />
            <arg line="-Dcarrot2.dir=${basedir}"/>
            <arg line="-Dtarget.platform=${target.platform}" />
            <arg line="-propertyfile ${basedir}/workbench.properties" />
        </java>

        <fail message="Access Restriction errors during build! Are you sure all packages from carrot2 are made visible at runtime?">
            <condition>
                <resourcecount when="greater" count="0" >
                    <fileset dir="${basedir}/${workbench.build.dir}/build-dir">
                        <include name="**/compilelogs/**" />
                        <contains text="Access restriction" />
                    </fileset>
                </resourcecount>
            </condition>
        </fail>
    </target>

    <target name="test" description="Builds workbench with test plugins and runs tests">
        <condition property="workbench.test.properties" 
                   value="${basedir}/workbench.test.properties"
                   else="${basedir}/workbench.properties">
          <available file="${basedir}/workbench.test.properties" />             
        </condition>

        <java jar="${eclipse.home}/plugins/${equinox.launcher.plugin.jar}"
              fork="true"
              failonerror="true">
            <arg line="-version:1.5" />
            <arg line="-application org.eclipse.ant.core.antRunner" />
            <arg line="-buildfile ${eclipse.home}/plugins/${pde.build.plugin}/scripts/productBuild/productBuild.xml" />
            <arg line="-Dbuilder=${basedir}/workbench/test-conf/" />
            <arg line="-DbuildDirectory=${basedir}/${workbench.build.dir}/test-dir" />
            <arg line="-Dcarrot2.dir=${basedir}"/>
            <arg line="-Dtarget.platform=${target.platform}" />
            <arg line="-propertyfile ${workbench.test.properties}" />
        </java>

        <fail message="Access Restriction errors during build! Are you sure all packages from carrot2 are made visible at runtime?">
            <condition>
                <resourcecount when="greater" count="0" >
                    <fileset dir="${basedir}/${workbench.build.dir}/test-dir">
                        <include name="**/compilelogs/**" />
                        <contains text="Access restriction" />
                    </fileset>
                </resourcecount>
            </condition>
        </fail>

        <java jar="${eclipse.home}/plugins/${equinox.launcher.plugin.jar}"
              fork="true"
              failonerror="true">
            <arg line="-application org.eclipse.ant.core.antRunner" />
            <arg line="-buildfile ${basedir}/${workbench.build.dir}/test-dir/${workbench.build.dir}/plugins/org.carrot2.workbench.core.test_1.0.0/test.xml" />
            <arg line="-Declipse-home=${basedir}/${workbench.build.dir}/test-dir/tmp/workbench" />
            <arg line="-Dos=${test.os} -Dws=${test.ws} -Darch=${test.arch}" />
        </java>

        <!-- JUnit report -->
        <mkdir dir="${workbench.tests.report.dir}" />
        <junitreport todir="${workbench.tests.report.dir}">
            <fileset dir="${basedir}/${workbench.build.dir}/test-dir/tmp/workbench">
                <include name="*.xml"/>
            </fileset>
            <report format="frames" todir="${workbench.tests.report.dir}"/>
        </junitreport>

        <copy todir="${workbench.tests.report.dir}">
          <fileset dir="${basedir}/${workbench.build.dir}/test-dir/tmp/workbench">
            <include name="*.xml" />
          </fileset>
          <mapper type="glob" from="*.xml" to="TEST-*.xml"/>
        </copy>

        <!-- 
             A hacky way of finding out whether tests passed. The Eclipse runner doesn't
             seem to expose this information directly.
        -->
        <loadfile property="testxml" srcFile="${workbench.tests.report.dir}/TESTS-TestSuites.xml" />
        <fail message="Tests failed, see ${workbench.tests.report.dir} for report.">
          <condition>
            <or>
              <matches string="${testxml}" pattern='errors="[1-9][0-9]*"' />
              <matches string="${testxml}" pattern='failures="[1-9][0-9]*"' />
              <matches string="${testxml}" pattern="errors='[1-9][0-9]*'" />
              <matches string="${testxml}" pattern="failures='[1-9][0-9]*'" />
            </or>
          </condition>
        </fail>
    </target>

    <target name="clean">
      <delete dir="tmp/workbench" />
    </target>
</project>
