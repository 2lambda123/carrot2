
<project name="Tomcat helper tasks" default="help" basedir=".">

    <property name="catalina.home" value="undefined" />
    <property name="catalina.config" value="${catalina.home}/conf/server.xml" />

    <!--
      ## Checks whether all the properties are ok.
      -->
    <target name="check.catalina.home">
        <available file="${catalina.home}" type="dir" property="tmp:catalina.avaialable" value="true" />
        <fail message="'catalina.home' not a directory: ${catalina.home}" unless="tmp:catalina.avaialable" />
        
        <!-- make absolute properties -->
        <property name="tomcat.home" location="${catalina.home}"/>
        <property name="tomcat.config" location="${catalina.config}" />
        <property environment="env"/>
    </target>


    <!--
      ## Starts catalina (never quits!).
      -->
    <target name="start.tomcat" depends="check.catalina.home"
            description="Stops tomcat. Define at least 'catalina.home' property.">
        <echo message="Starting Tomcat (Catalina) in ${catalina.home}"/>

        <java classname="org.apache.catalina.startup.Bootstrap" fork="yes"
          output="/home/dweiss/carrot2/logs-cron/catalina-stdout.log"
          error="/home/dweiss/carrot2/logs-cron/catalina-stderr.log"
          append="true"
        >
            <jvmarg value="-Dcatalina.home=${tomcat.home}"/>
            <jvmarg value="-Dgoogleapi.keypool=${tomcat.home}/keypool"/>
            <arg value="-config"/>
            <arg value="${tomcat.config}"/>
            <arg value="start"/>
            <classpath>
                <pathelement path="${env.JAVA_HOME}/lib/tools.jar"/>
                <fileset dir="${tomcat.home}">
                    <include name="bin/bootstrap.jar"/>
                </fileset>
            </classpath>
        </java>
    </target>


    <!--
      ## Stops catalina (always successfull)
      -->
    <target name="stop.tomcat" depends="check.catalina.home" 
            description="Stops tomcat. Define at least 'catalina.home' property.">
        <echo message="Stopping Tomcat (Catalina) in ${catalina.home}"/>

        <java classname="org.apache.catalina.startup.Bootstrap" fork="yes" 
              failonerror="false">
            <jvmarg value="-Dcatalina.home=${tomcat.home}"/>
            <arg value="-config"/>
            <arg value="${tomcat.config}"/>
            <arg value="stop"/>
            <classpath>
                <pathelement path="${env.JAVA_HOME}/lib/tools.jar"/>
                <fileset dir="${tomcat.home}">
                    <include name="bin/bootstrap.jar"/>
                </fileset>
            </classpath>
        </java>
    </target>


  <!-- ##################################### -->
  <!-- ### {{{ HELP ON THIS FILE         ### -->
  <!-- ##################################### -->
    <target name="help" description="Displays help on available targets.">
        <echo>

    Project name: ${ant.project.name}
    (c) Dawid Weiss, Poznan University of Technology.

    Current JDK: ${ant.java.version}
    Basedir    : ${basedir}
    -----------------------------------------------------

    A set of useful Tomcat (Catalina) related tasks.

    </echo>
    </target>
  <!-- }}} -->

</project>

