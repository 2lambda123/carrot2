<?xml version="1.0" encoding="UTF-8" ?>

<project name="Carrot2 3.0 Bamboo builds" default="help">
    <property file="${bamboo.build.properties}" />

    <target name="build" description="Perform a full build of the core">
        <fail unless="carrot2.code.dir">Define: carrot2.code.dir</fail>

        <!-- clean everything -->
        <ant dir="${carrot2.code.dir}" antfile="build.xml" target="clean" inheritall="true" />

        <!-- full build and test of all components -->
        <ant dir="${carrot2.code.dir}" antfile="build.xml" target="test" inheritall="true" />

        <!-- build coverage report -->
        <ant dir="${carrot2.code.dir}" antfile="build.xml" target="coverage" inheritall="true" />

        <!-- code duplication report -->
        <ant dir="${carrot2.code.dir}" antfile="build.xml" target="duplication" inheritall="true" />

        <!-- FindBugs -->
        <ant dir="${carrot2.code.dir}" antfile="build.xml" target="findbugs" inheritall="true" />
    </target>

    <target name="publish.demo">
        <fail unless="webapp.name">Define: webapp.name property.</fail>
        <fail unless="webapps.dir">Define: webapps.dir property.</fail>
        <fail unless="tomcat.init">Define: tomcat.init property.</fail>

        <!-- Build and deploy webapp -->
        <ant dir="${carrot2.code.dir}" antfile="build.xml" target="clean.classes" inheritall="true" />
        <ant dir="${carrot2.code.dir}" antfile="build.xml" target="webapp.build" inheritall="true" />

        <copy file="${carrot2.code.dir}/tmp/webapp/carrot2-webapp.war"
              tofile="${webapps.dir}/${webapp.name}.war"
              overwrite="true" />
    </target>

    <target name="workbench" description="Perform a full build of the workbench">
        <fail unless="carrot2.code.dir">Define: carrot2.code.dir</fail>
        <fail unless="dist.dir">Define: dist.dir property.</fail>

        <copy file="${workbench.properties}" todir="${carrot2.code.dir}" overwrite="true" />
        <copy file="${workbench.test.properties}" todir="${carrot2.code.dir}" overwrite="true" />
        
        <!-- clean everything -->
        <ant dir="${carrot2.code.dir}" antfile="build-workbench.xml" target="clean" inheritall="true" />

        <!-- test the workbench -->
        <ant dir="${carrot2.code.dir}" antfile="build-workbench.xml" target="test" inheritall="true" />

        <!-- build the workbench -->
        <ant dir="${carrot2.code.dir}" antfile="build-workbench.xml" target="build" inheritall="true" />

        <!-- copy to the distribution dir -->
        <mkdir dir="${dist.dir}" />
        <copy todir="${dist.dir}">
            <fileset dir="${carrot2.code.dir}/tmp/workbench/build-dir">
                <include name="*carrot2-workbench/*.zip" />
            </fileset>
            <mapper type="flatten" />
        </copy>
    </target>

    <target name="help">
        <echo>This file is used to drive automated Bamboo builds.</echo>
    </target>

    <target name="check">
      <fail unless="carrot2.code.dir">Define: carrot2.code.dir</fail>

      <echo>All required variables defined.</echo>
    </target>
</project>
